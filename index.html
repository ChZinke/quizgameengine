<!DOCTYPE html>
<html>
<head>
    <title>Application</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
            integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
            crossorigin="anonymous"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
            integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
            crossorigin="anonymous"></script>
    <style>

    </style>
</head>
<body>


<header>
      <div class="collapse  bg-dark" id="navbarHeader">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4 class="text-white">About</h4>
              <p class="text-muted">This is an easy quiz. Add more text here if needed, otherwise play.</p>
            </div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4 class="text-white">Contact</h4>
              <ul class="list-unstyled">
                <li><a href="#" class="text-white">Follow on Twitter</a></li>
                <li><a href="#" class="text-white">Github</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="navbar navbar-dark bg-dark box-shadow">
        <div class="container d-flex justify-content-between">
          <a href="#" class="navbar-brand d-flex align-items-center">
            <strong>PAQ - Next level quizing</strong>
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </div>
</header>

<main role="main">
    <section class="jumbotron text-center" id="menu" >
        <div class="row">
            <div class="container px-lg-5" style="display:inline">
                <div style="padding-top: 20px;">
                    <form onsubmit=" return startLobby()">
                        <select id="quiz_select" class="custom-select custom-select-lg mb-3">
                            <option value="1" selected>Filme</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                        </select>
                        <button class="btn btn-primary my-2">Create a game</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4 box-shadow">
                    <div class="card-body">
                        <img class="card-img-top" data-src="holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=PlayTheGame" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_169c9f4fabb%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_169c9f4fabb%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.7265625%22%20y%3D%22120.3%22%3EPlayTheGame%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
                        <p class="card-text">Spiel 1: Filmeraten, bisher 2 Spieler wartend</p>
                        <p class="card-text">
                        <ul class="list-group">
                            <li class="list-group-item">Ulf</li>
                            <li class="list-group-item">Sophi</li>
                        </ul>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Join</button>
                            </div>
                            <small class="text-muted">1 min ago started</small>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="card mb-4 box-shadow">
                    <div class="card-body">
                        <img class="card-img-top" data-src="holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=PlayTheGame" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_169c9f4fabb%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_169c9f4fabb%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.7265625%22%20y%3D%22120.3%22%3EPlayTheGame%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
                        <p class="card-text">Spiel 1: Filmeraten, bisher 2 Spieler wartend</p>
                        <p class="card-text">
                        <ul class="list-group">
                            <li class="list-group-item">Ulf</li>
                            <li class="list-group-item">Sophi</li>
                        </ul>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Join</button>
                            </div>
                            <small class="text-muted">1 min ago started</small>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="card mb-4 box-shadow">
                    <div class="card-body">
                        <img class="card-img-top" data-src="holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=PlayTheGame" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_169c9f4fabb%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_169c9f4fabb%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.7265625%22%20y%3D%22120.3%22%3EPlayTheGame%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
                        <p class="card-text">Spiel 1: Filmeraten, bisher 2 Spieler wartend</p>
                        <p class="card-text">
                        <ul class="list-group">
                            <li class="list-group-item">Ulf</li>
                            <li class="list-group-item">Sophi</li>
                        </ul>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Join</button>
                            </div>
                            <small class="text-muted">1 min ago started</small>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>


<div class="py-5 bg-light" id="room" style="display:none;">
    	<div class="container-fluid h-100" id="room_inline" >
			<div class="row justify-content-center h-100">
				<div class="col-md-4 col-xl-3 chat"><div class="card mb-sm-3 mb-md-0 contacts_card">
					<div class="card-header">
						<div class="input-group">
							<input type="text" placeholder="Search..." name="" class="form-control search">
							<div class="input-group-prepend">
								<span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
							</div>
						</div>
					</div>
					<div class="card-body contacts_body">
						<ui class="contacts" id="contacts">

						</ui>
					</div>
					<div class="card-footer"></div>
				</div></div>
				<div class="col-md-8 col-xl-6 chat">
					<div class="card">
						<div class="card-header msg_head">
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="/img/132_Chess_laptop_strategy_game-256.png" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>Spiellobby für Spiel 1</span>
									<p>der wahnsinn</p>
								</div>
								<div class="video_cam">
									<span><i class="fas fa-video"></i></span>
									<span><i class="fas fa-phone"></i></span>
								</div>
							</div>
							<span id="action_menu_btn"><i class="fas fa-ellipsis-v"></i></span>

						</div>
						<div class="card-body msg_card_body" id="messages">


						</div>
                         <form onsubmit="return sendMessage()">
						<div class="card-footer">

							<div class="input-group">
								<div class="input-group-append">
									<span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
								</div>

								<textarea name="" class="form-control type_msg" placeholder="Type your message..." id="message"></textarea>
								<div class="input-group-append">
									<button class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></button>
								</div>

							</div>
						</div>
                        </form>
					</div>
				</div>
			</div>
		</div>

</div>


<div id="game" class="container" style="display:none">
    <div id="myProgress">
        <div id="myBar"></div>
    </div>
    <div class="row justify-content-md-center">
        <div class="col-10 alert alert-success" role="alert"><h2 id="question">Frage</h2></div>
        <!-- answerbox, answerrow are no real classes but needed for shuffling, please dont remove-->
        <div class="col-10 py-3 px-lg-5 border bg-light answerbox">
            <div class="row mx-lg-n5 answerrow">
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="0"><h2 id="a1">A1</h2></div>
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="1"><h2 id="a2">A2</h2></div>
            </div>

            <div class="row mx-lg-n5 answerrow">
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="2"><h2 id="a3">A3</h2></div>
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="3"><h2 id="a4">A4</h2></div>
            </div>
        </div>
        <div class="col-10 alert alert-success" role="alert"><h2>Your Score: </h2><h2 id="score">0</h2></div>
        <div id="items" class="col-10 align-bottom">

        </div>
        <div id="ingame_scoreboard" class="container">
            <div class="col-8 alert alert-success" role="alert" id="ingame_scores"><h2>Scoreboard</h2>
                <div id="ingame_scores-id"></div>
            </div>
        </div>
    </div>
</div>

<div id="scoreboard" class="container" style="display:none">
    <div class="col-8 alert alert-success" role="alert" id="scores"><h2>Scoreboard</h2>
        <div id="scores-id"></div>
    </div>
    <form onsubmit=" return backToMenu()">
      <button style="width: 25%">Back to Menu</button>
    </form>
</div>
</main>

<!-- game functions -->
<script>
    var pID = -1;
    var gameID = -1;
    var progressBar = null;
    var jackpot = null;
    var baseURI = "localhost:8888";
    var quizzes = null;
    var ws = null;
    var items = {}; //will hold the available items in form: {"item_name":"quantity"}, e.g. { "scoreX2": 1 }
    var activeScoreItem = null; //only one score multiplicator allowed per question (i.e. 2x and x5 not combineable)
    var activeJackpotItem = false;
    var keepAnimating = false;
    var savePoints = false;

    window.onload = function(){
        getMainPageData();
    }

    function getMainPageData(){
        getQuizzes();
        //later also: get all open lobbies, ...
    }

    function getQuizzes(){

        var req = $.ajax({
            url: "/quizzes",
            method: "GET",
            contentType: "application/json",
            dataType: "json",
            success: function(response){
                        quizzes = response;
                        clearChildren("quiz_select");
                        var selectBox = document.getElementById("quiz_select");
                        quizzes.forEach(function(quiz){
                            var option = document.createElement("option");
                            option.text = quiz.title;
                            option.value = quiz.id;
                            selectBox.appendChild(option);
                        });
                    },
            error: function(xhr, textStatus, error){
                        console.log(xhr.status);
                        console.log(textStatus);
                        console.log(error);
                    }
        });


    }

    function onclickanswer(btn, question, jackpot, startTime){
        //measure elapsed time in seconds, startTime is when question message arrived
        var endTime = new Date();
        var timeDiff = endTime - startTime;
        var timeInSeconds = timeDiff / 1000;

        keepAnimating = false;
        $(".answer").stop(true,true);
        var answers = document.getElementsByClassName("answer");
        for(var i = 0; i < answers.length; i++){
            answers[i].style.removeProperty("top");
            answers[i].style.removeProperty("left");
        }

        var payload = {
            "type": "answered_question",
            "p_id": pID,
            "game_id": gameID,
            "q_id": question.id,
            "a_id" : parseInt(btn.id) + 1
        };
        //stop the timer
        clearTimeout(progressBar);
        //evaluate the given answer
        var evalPayload = evalQuestion(btn, question, jackpot, timeInSeconds);
        payload['played_question'] = evalPayload;
        //send answer to the server
        sendSocket(payload);
    }

    function evalQuestion(pressedBtn, question, jackpot, time){
        //first disable all button onclicks
        var b_answers = document.getElementsByClassName('answer');
        for (var i=0; i<b_answers.length; i++){
            b_answers[i].onclick = false;
        }

        //if jackpot item was triggered
        if(activeJackpotItem){
            jackpot.is_active = true;
        }

        var payload = {
            'speed': time,
            'is_jackpot': jackpot.is_active
        };

        //correct answer was chosen, make this button green
        if(parseInt(pressedBtn.id) == 0){
            pressedBtn.className = "col py-3 px-lg-5 btn btn btn-success answer";
            payload['is_correct'] = true;
            payload['score'] = computeAndSetScore(jackpot, activeScoreItem, time, question.worth);
        }
        //wrong answer chosen, make pressed button red and button with correct answer green
        else{
            pressedBtn.className = "col py-3 px-lg-5 btn btn btn-danger answer";
            //we cant directly access the buttons div with id=0 because also in lobby there are divs with id's
            //--> wrong element could be taken, to avoid that loop only over answers
            for(var i = 0; i < b_answers.length; i++){
                if(b_answers[i].id == 0){
                    b_answers[i].className = "col py-3 px-lg-5 btn btn btn-success answer";
                }
            }
            payload['is_correct'] = false;

            //item get_save_points was triggered
            if(savePoints){
                payload['score'] = computeAndSetScore(jackpot, activeScoreItem, time, question.worth);

                //reset indicator
                savePoints = false;
            }
            else{
                payload['score'] = 0;
            }
        }

        //reset the active score item, so that in the next round another item can potentially be activated
        activeScoreItem = null;

        //reset the active jackpot item
        activeJackpotItem = false;

        //simply remove the old elements since all will be reset further down
        clearChildren("items");

        //add item to the collection if the button had one assigned
        //TODO send msg to server that item has been aquired by player
        var item = pressedBtn.getElementsByClassName("item")[0];
        if(item){
            var itemName = item.textContent;
            if (items[itemName]){
                items[itemName] += 1;
            }
            else{
                items[itemName] = 1;
            }
            //append message part to payload that item has been acquired
            payload['acquired_item'] = itemName;
        }
        //append a div for every item, this div will hold two p's for text and quantity
        //TODO for now they will be reset every time, maybe only reset them if there actually was an item assigned to the clicked button (not too important but good for performance)
        var itemBox = document.getElementById("items");
        for (var item in items){
            var itemDiv = document.createElement("div");
            itemDiv.id = item;
            var itemBtn = document.createElement("button");
            itemBtn.className = "btn btn-outline-info";
            var itemText = document.createElement("p");
            itemText.className = "item-text";
            itemText.appendChild(document.createTextNode(item));
            var itemQuantity = document.createElement("p");
            itemQuantity.className = "item-quantity";
            itemQuantity.appendChild(document.createTextNode(items[item]));
            itemBtn.appendChild(itemText);
            itemBtn.appendChild(itemQuantity);
            itemBtn.onclick = function(e){ onclickitem(this);};
            itemDiv.appendChild(itemBtn);
            itemBox.appendChild(itemDiv);

        }

        return payload;
    }

    function computeAndSetScore(jackpot, item, time, worth){
        var score = parseInt(document.getElementById("score").innerHTML);
        var currentScore = parseInt(worth);
        if(jackpot.is_active){
            currentScore += getAmountOfJackpot(time, jackpot);
        }
        currentScore = computeScoreIfItem(item, currentScore);
        score += currentScore;
        document.getElementById("score").innerHTML = score;
        return currentScore;
    }

    function computeScoreIfItem(item, currentScore){
        if(item){
            switch(item){
                case "scoreX2": {
                    return currentScore * 2;
                    console.log("score X 2")
                }
                break;
                case "scoreX5": {
                    return currentScore * 5;
                    console.log("score X 5");
                }
                break;
                case "score/2": {
                    return currentScore / 2;
                    console.log("score / 2");
                }
                break;
            }
        }
        else{
            return currentScore;
        }
    }

    //evaluation called when timer runs out, treated as wrong answer
    function evalQuestionNotAnswered(time, isJackpot){
        //stop animation in case moving answer item was triggered
        keepAnimating = false;
        $(".answer").stop(true,true);
        var answers = document.getElementsByClassName("answer");
        for(var i = 0; i < answers.length; i++){
            answers[i].style.removeProperty("top");
            answers[i].style.removeProperty("left");
        }

            var payload = {
                'type': 'answered_question',
                'p_id': pID,
                'game_id': gameID,
                'q_id': -1, //TODO get the corrent question id in here (pass through like isJackpot) or make the server recognize this -1 indicating not answered
                'a_id': 4, //not as severe as above since answer_id 4 is always a wrong answer
                'played_question': {
                    'speed': time,
                    'is_correct': false,
                    'is_jackpot': isJackpot,
                    'score': 0
                }
            };
            sendSocket(payload);
    }

    //activates the item, note that only one score multiplicator is allowed per round
    //TODO make the button "look" clicked (enabled attribute?!)
    //TODO maybe move the lowering of the quantity to evaluation because if it is instantly adjusted (as it is now) it might cause confusion
    function onclickitem(button){
        var activeItemQuantity = parseInt(button.getElementsByClassName("item-quantity")[0].textContent);
        var activeItemText = button.getElementsByClassName("item-text")[0].textContent;

        if(["scoreX2", "scoreX5"].includes(activeItemText)){ //activated a score multiplier, check if there is another one active
            if(!activeScoreItem){
                //check quantity on frontend and also on backend
                if(activeItemQuantity > 0 && checkItemQuantity(activeItemText)){
                    activeScoreItem = activeItemText;

                    //lower quantity
                    lowerItemQuantity(button, activeItemText);
                }
            }
        }
        else{ //item is no score multiplier, so we can always activate it
            if(activeItemQuantity > 0 && checkItemQuantity(activeItemText)){

                // bomb (aka remove 2 wrong answers), save points is only for the player that activated it --> needs no broadcast
                if(!(['bomb', 'get_points_save'].includes(activeItemText))){
                    //send message to the server to broadcast the effect to other players
                    var payload = {
                        'type': 'item_activation',
                        'p_id': pID,
                        'game_id': gameID,
                        'item': activeItemText
                    }
                    sendSocket(payload);
                }
                else{
                    switch(activeItemText){
                        //bomb item, make 2 wrong answers red, simply take answer 3 and 4, since they are shuffled it doenst matter
                        case "bomb": {
                            document.getElementById("2").className = "col py-3 px-lg-5 btn btn btn-danger answer";
                            document.getElementById("3").className = "col py-3 px-lg-5 btn btn btn-danger answer";
                        }
                        break;

                        //get points even if given answer was wrong
                        case "get_points_save": {
                            savePoints = true;
                        }
                    }
                }

                //lower quantity
                lowerItemQuantity(button, activeItemText);
            }
        }
    }

    //lower item quantity of "item" and render the display on the "button"
    //just separated in a function for means of modularisation
    function lowerItemQuantity(button, item){
        items[item] -= 1;
        button.getElementsByClassName("item-quantity")[0].textContent = items[item];
    }

    //compute amount of jackpot depending on time taken to answer
    function getAmountOfJackpot(time, jackpot){
        if(time < 5){
            return jackpot.amount;
        }
        else if(time >= 5 && time < 10){
            return jackpot.amount * 0.9;
        }
        else if(time >= 10 && time < 15){
            return jackpot.amount * 0.7;
        }
        else if(time >= 15 && time <20){
            return jackpot.amount * 0.5;
        }
        else if(time >= 20 && time < 25){
            return jackpot.amount * 0.3;
        }
        else if(time >= 25 && time < 30){
            return jackpot.amount * 0.1;
        }
        else return 0;
    }

    function startLobby(){
        //hide menu and show lobby
      document.getElementById("menu").style.display = "none"
      document.getElementById("room").style.display = "inline"

      //get the selected quiz from the dropdown list
      var selectBox = document.getElementById("quiz_select");
      var quizID = selectBox.options[selectBox.selectedIndex].value;
      ws = new WebSocket("ws://localhost:8888/websocket/p_id/" + pID);
      ws.onmessage = messageHandle;
      //need to wrap this in onopen here to wait for the connection to actually be established, otherwise it might not send the message
      ws.onopen = function(e){
            var payload = {
                "type": "join_lobby",
                "p_id": pID,
                "q_id": quizID
            }
            sendSocket(payload);
      }
      return false;
    }

    function startGame() {
        //hide lobby, delete chat and show game
        document.getElementById("room").style.display = "none"
        clearChildren("messages");
        document.getElementById("game").style.display = "inline"
        return false;
    }
    function startScoreboard(){
        //hide game and show scoreboard
        document.getElementById("game").style.display = "none"
        document.getElementById("scoreboard").style.display = "inline"

        //close the websocket
        ws.close();
    }
    function backToMenu(){
        //hide scoreboard and show menu
        document.getElementById("scoreboard").style.display = "none"
        document.getElementById("menu").style.display = "inline"

        return false;
    }

    //timer bar function; we need to pass jackpot activation here because when time runs out an evaluation signaling "wrong answer"
    //will be send to server, for correct equation of jackpot probabilities it needs to know if question was a jackpot
    function move(timeLeft, maxTime, isJackpot) {
        var elem = $('#myProgress');
        var progressWidth = timeLeft * elem.width() / maxTime;
        elem.find('div').animate({width: progressWidth}, 500).html(timeLeft);
        if(timeLeft > 0){ //still time, call again
            progressBar = setTimeout(move, 1000, timeLeft - 1, maxTime, isJackpot);
        }
        else { //time is up
            evalQuestionNotAnswered(maxTime, isJackpot);
        }
    }

    //improvised login, to be implemented correctly at last because logging in with username + password everytime is annoying
    var username = prompt("What's your name?");
    $.ajax({
        url: "/login",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({"username": username}),
        dataType: "json",
        success: function(response){
            if (response.p_id != -1){
                pID = response.p_id;
                alert("Successfully logged in");
            }
            else{
                alert("user not known");
                //reload the page
                window.location.reload();
            }
        }
    });

    //websocket message handles
    function messageHandle(evt) {
        console.log(evt.data)
        //parse the json response
        var messageDict = JSON.parse(evt.data);
        if ('type' in messageDict) { //type always needs to be in the response
            switch (messageDict.type) {
                //display chat messages
                case "user_message": {
                    displayChatMessage(messageDict.message);
                }
                break;
                //close connect
                case "close": {
                    //do nothing for now
                }
                //a player joined the lobby
                case "lobby": {
                    //remove all old users from the box to avoid duplicates
                    clearChildren("contacts");

                    //put the users
                    displayUsersInLobby(messageDict.lobby, messageDict.nicks);
                }
                break;
                //enough players in the lobby --> games starts
                case "game_start":{
                    gameID = messageDict.game_id;
                    var payload = {
                        'type': 'game_id_check',
                        'game_id': gameID
                    }
                    sendSocket(payload);
                    startGame();
                }
                break;
                //play a question
                case 'question': {
                    displayQuestion(messageDict.question);

                    var startTime = new Date();

                    var b_answers = document.getElementsByClassName('answer');
                    for (var i=0; i < b_answers.length; i++){
                        b_answers[i].onclick = function(e){ onclickanswer(this, messageDict.question, messageDict.jackpot, startTime) };
                        b_answers[i].className = "col py-3 px-lg-5 btn btn-outline-info answer";
                    }

                    //function to shuffle answers across 2 hierarchy levels
                    //this solution is pretty dirty though
                    //any other place except here threw UncaughtReferenceError for $ (dont know why)
                    $.fn.randomize = function(a,b) {
                        return this.each(function() {
                            var $this = $(this);
                            var elems = $this.children(a).children(b);
                            var len = $this.find(a).eq(0).find(b).length;
                            elems.sort(function() {
                                return (Math.round(Math.random())-0.5); });
                            $this.detach(a);
                            for(var i=0; i < elems.length; i++) {
                      	         $this.find(a).eq(i%len).append(elems[i]);
                             }

                        });
                    }
                    //shuffle answers
                    $('.answerbox').randomize('.answerrow', '.answer');

                    //set the ingame Scoreboard
                    displayIngameScoreboard(messageDict.scoreboard);

                    //reset + restart the timer bar
                    document.getElementById("myBar").style.width = '0%';
                    var time = messageDict.question.responseTime;
                    move(time, time, messageDict.jackpot.is_active);

                }
                break;
                //item has been activated by another player
                case "item_activation": {
                        var item = messageDict.item;
                        //possible effects
                        switch(item){
                            //divide score by 2
                            case "score/2": {
                                activeScoreItem = item;
                            }
                            break;

                            //shuffle word order of question
                            case "shuffle_question":{
                                var question = document.getElementById("question").innerHTML;
                                question = shuffle(question);
                                document.getElementById("question").innerHTML = question;
                            }
                            break;

                            //trigger a jackpot
                            case "jackpot": {
                                activeJackpotItem = true;
                            }
                            break;

                            case "move_answers": { //TODO fix that they dont go out of screen
                                //start the animation
                                keepAnimating = true;
                                animateAnswers();

                            }
                            break;

                            case 'hide_scoreboard': {
                                document.getElementById("ingame_scoreboard").style.display = "none";
                            }
                            break;

                        }
                }
                break;
                //all questions played --> show scoreboard
                case "scoreboard": {

                    //remove any old scores from previous games
                    clearChildren("scores-id");

                    //create new div containing playerID : score for each participant
                    for(playerID in messageDict.scoreboard){
                        var scoreBox = document.createElement("div");
                        if(playerID == pID){ //my own score
                            scoreBox.innerHTML = "you: " + messageDict.scoreboard[playerID];
                        }
                        else{
                            scoreBox.innerHTML = playerID + ": " + messageDict.scoreboard[playerID];
                        }
                        document.getElementById("scores-id").appendChild(scoreBox);
                    }
                    startScoreboard();

                }
                break;
            }
        } else {
            alert('"type" key missing in message')
        }
        ;
    };

    function checkItemQuantity(item){
        var payload = {
            'p_id': pID,
            'game_id': gameID,
            'item': item
        };
        //make a synchronous ajax call to immediatly wait for the response
        return $.ajax({
            url: "/checkItemQuantity",
            method: "POST",
            contentType: "application/json",
            async: false,
            timeout: 1500,
            data: JSON.stringify(payload),
            dataType: "json",
            success: function(response){
                if(response.activate == true){
                    console.log("item activation: " + item + " granted by server")
                    return true;
                }
                else return false;
            },
            error: function(response){
                return false;
            }
        });

    }

    function shuffle(question){
        //helper function to shuffle words using adapted fisher-yates algorithm
        function shuffle_words(arr){
            var len = arr.length;
            var swap;
            var i;

            while (len > 0) {
                i = Math.floor(Math.random() * len);
                len--;
                swap = arr[len];
                arr[len] = arr[i];
                arr[i] = swap;
            }
            return arr;
        }

        var words = question.split(' ');
        return shuffle_words(words).join(' ');
    }

    //send a chat message to the server, will be broadcasted to players
    function sendMessage() {
        var messageInput = document.getElementById("message");
        var message = messageInput.value;
        var payload = {
            "type": "user_message",
            "message": message,
            "p_id": pID
        }
        // Make the request to the WebSocket.
        sendSocket(payload);
        // Clear the message from the input.
        messageInput.value = "";
        return false;
    }

    function displayChatMessage(message){
        var messageBox = document.createElement("div");
        messageBox.className = 'd-flex justify-content-start mb-4';
        var userbox = document.createElement('div');
        userbox.className = 'img_cont_msg';
        var userimg = document.createElement('img');
        userimg.className =  'rounded-circle user_img_msg'
        userimg.src = '/img/iconfinder_icon-64-face-sunglasses_315578.png';
        userbox.appendChild(userimg);
        var usermsg = document.createElement('div');
        usermsg.className = "msg_cotainer";
        usermsg.innerHTML = message;
        var usertime = document.createElement('span');
        usertime.className = "msg_time";
        var time = new Date().toLocaleTimeString();
        usertime.innerHTML = time;
        usermsg.appendChild(usertime);
        messageBox.appendChild(userbox);
        messageBox.appendChild(usermsg);
        document.getElementById("messages").appendChild(messageBox)
    }

    function displayUsersInLobby(lobby, nicks){
        for (id in lobby) {
            var userBox = document.createElement("li");
            userBox.className = 'active';
            //userBox.innerHTML = messageDict.lobby[id];
            var userdiv = document.createElement('div');
                userdiv.className = 'd-flex bd-highlight';
            var imgdiv = document.createElement('div');
                imgdiv.className = 'img_cont';
            var uimg = document.createElement('img');
                uimg.className = 'rounded-circle user_img';
                uimg.src = '/img/iconfinder_icon-64-face-sunglasses_315578.png';
            var uimgspan = document.createElement('span');
                uimgspan.className = 'online_icon';
            imgdiv.appendChild(uimg)
            imgdiv.appendChild(uimgspan)
            var udivdesc = document.createElement('div');
                udivdesc.className = 'user_info';
            var udivtext = document.createElement('span');
                udivtext.innerHTML = nicks[id];
            udivdesc.appendChild(udivtext)
            userdiv.appendChild(imgdiv)
            userdiv.appendChild(udivdesc)
            userBox.appendChild(userdiv)
            userBox.setAttribute('id', lobby[id]);
            document.getElementById("contacts").appendChild(userBox);
        }
    }

    function displayQuestion(question){
        document.getElementById('question').innerHTML = question.questioning;
        var answers = question.answers;
        for (answerid in answers ){
            var answerElement = document.getElementById("a"+(parseFloat(answerid)+1))
            answerElement.innerHTML = answers[answerid].content;
            if (answers[answerid].hasOwnProperty("assigned_effect")){
                var effectElement = document.createElement('i');
                effectElement.className = "fas fa-star ml-5 item";
                effectElement.appendChild(document.createTextNode(answers[answerid].assigned_effect));
                answerElement.appendChild(effectElement);
            }
        }
    }

    function displayIngameScoreboard(scoreboard){
        document.getElementById("ingame_scoreboard").style.display = "inline";
        clearChildren("ingame_scores-id");
        for(playerID in scoreboard){
            var scoreBox = document.createElement("div");
            if(playerID == pID){ //my own score
                scoreBox.innerHTML = "you: " + scoreboard[playerID];
            }
            else{
                scoreBox.innerHTML = playerID + ": " + scoreboard[playerID];
            }
            document.getElementById("ingame_scores-id").appendChild(scoreBox);
        }
    }

    function animateAnswers(){

        function newPosition(widthOfObj, heightOfObj){
            var h = $(window).height() - heightOfObj;
            var w = $(window).width() - widthOfObj;

            var newH = Math.floor(Math.random() * (h-heightOfObj));
            var newW = Math.floor(Math.random() * (w-widthOfObj));

            return [newH, newW];
        }

        function animateAnswer(index){
            var height = $("#" + index).height();
            var width = $("#" + index).width();
            var newPos = newPosition(width, height);
            $("#" + index).animate({top: newPos[0], left: newPos[1]}, 1000,
                function(){
                    if(keepAnimating){
                        animateAnswer(index);
                    }
                });
        }

        for(var i = 0; i < 4; i++){
            animateAnswer(i);
        }
    }


    //helper function to clear child nodes
    function clearChildren(parentID){
        var parent = document.getElementById(parentID);
        if(parent){
            while(parent.firstChild){
                parent.removeChild(parent.firstChild);
            }
        }
    }

    //wrapper to send a message to the server via socket
    function sendSocket(payload){
        jsonMessage = JSON.stringify(payload)
        ws.send(jsonMessage);
        console.log("sent: " + jsonMessage);
    }
</script>

</body>
</html>
