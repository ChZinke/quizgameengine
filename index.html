<!DOCTYPE html>
<html>
<head>
    <title>Application</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/css/style.css">

    <style>

    </style>
</head>
<body>


<header>
      <div class="collapse  bg-dark" id="navbarHeader">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4 class="text-white">About</h4>
              <p class="text-muted">This is an easy quiz. Add more text here if needed, otherwise play.</p>
            </div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4 class="text-white">Contact</h4>
              <ul class="list-unstyled">
                <li><a href="#" class="text-white">Follow on Twitter</a></li>
                <li><a href="#" class="text-white">Github</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="navbar navbar-dark bg-dark box-shadow">
        <div class="container d-flex justify-content-between">
          <a href="#" class="navbar-brand d-flex align-items-center">
            <strong>PAQ - Next level quizing</strong>
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </div>
</header>

<main role="main">
    <section class="jumbotron text-center" id="menu" >
        <div class="row">
            <div class="container px-lg-5" style="display:inline">
                <div style="padding-top: 20px;">
                    <form onsubmit=" return startLobby()">
                        <select class="custom-select custom-select-lg mb-3">
                            <option selected>Spiele</option>
                            <option value="1">Filme</option>
                            <option value="2">Two</option>
                            <option value="3">Three</option>
                        </select>
                        <button class="btn btn-primary my-2">Create a game</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4 box-shadow">
                    <div class="card-body">
                        <img class="card-img-top" data-src="holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=PlayTheGame" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_169c9f4fabb%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_169c9f4fabb%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.7265625%22%20y%3D%22120.3%22%3EPlayTheGame%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
                        <p class="card-text">Spiel 1: Filmeraten, bisher 2 Spieler wartend</p>
                        <p class="card-text">
                        <ul class="list-group">
                            <li class="list-group-item">Ulf</li>
                            <li class="list-group-item">Sophi</li>
                        </ul>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Join</button>
                            </div>
                            <small class="text-muted">1 min ago started</small>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="card mb-4 box-shadow">
                    <div class="card-body">
                        <img class="card-img-top" data-src="holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=PlayTheGame" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_169c9f4fabb%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_169c9f4fabb%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.7265625%22%20y%3D%22120.3%22%3EPlayTheGame%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
                        <p class="card-text">Spiel 1: Filmeraten, bisher 2 Spieler wartend</p>
                        <p class="card-text">
                        <ul class="list-group">
                            <li class="list-group-item">Ulf</li>
                            <li class="list-group-item">Sophi</li>
                        </ul>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Join</button>
                            </div>
                            <small class="text-muted">1 min ago started</small>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="card mb-4 box-shadow">
                    <div class="card-body">
                        <img class="card-img-top" data-src="holder.js/100px225?theme=thumb&amp;bg=55595c&amp;fg=eceeef&amp;text=PlayTheGame" alt="Thumbnail [100%x225]" style="height: 225px; width: 100%; display: block;" src="data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22348%22%20height%3D%22225%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20348%20225%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_169c9f4fabb%20text%20%7B%20fill%3A%23eceeef%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A17pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_169c9f4fabb%22%3E%3Crect%20width%3D%22348%22%20height%3D%22225%22%20fill%3D%22%2355595c%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22116.7265625%22%20y%3D%22120.3%22%3EPlayTheGame%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E" data-holder-rendered="true">
                        <p class="card-text">Spiel 1: Filmeraten, bisher 2 Spieler wartend</p>
                        <p class="card-text">
                        <ul class="list-group">
                            <li class="list-group-item">Ulf</li>
                            <li class="list-group-item">Sophi</li>
                        </ul>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary">Join</button>
                            </div>
                            <small class="text-muted">1 min ago started</small>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>


<div class="py-5 bg-light" id="room" style="display:none;">
    	<div class="container-fluid h-100" id="room_inline" >
			<div class="row justify-content-center h-100">
				<div class="col-md-4 col-xl-3 chat"><div class="card mb-sm-3 mb-md-0 contacts_card">
					<div class="card-header">
						<div class="input-group">
							<input type="text" placeholder="Search..." name="" class="form-control search">
							<div class="input-group-prepend">
								<span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
							</div>
						</div>
					</div>
					<div class="card-body contacts_body">
						<ui class="contacts" id="contacts">

						</ui>
					</div>
					<div class="card-footer"></div>
				</div></div>
				<div class="col-md-8 col-xl-6 chat">
					<div class="card">
						<div class="card-header msg_head">
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="/img/132_Chess_laptop_strategy_game-256.png" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>Spiellobby f√ºr Spiel 1</span>
									<p>der wahnsinn</p>
								</div>
								<div class="video_cam">
									<span><i class="fas fa-video"></i></span>
									<span><i class="fas fa-phone"></i></span>
								</div>
							</div>
							<span id="action_menu_btn"><i class="fas fa-ellipsis-v"></i></span>

						</div>
						<div class="card-body msg_card_body" id="messages">


						</div>
                         <form onsubmit="return sendMessage()">
						<div class="card-footer">

							<div class="input-group">
								<div class="input-group-append">
									<span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
								</div>

								<textarea name="" class="form-control type_msg" placeholder="Type your message..." id="message"></textarea>
								<div class="input-group-append">
									<button class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></button>
								</div>

							</div>
						</div>
                        </form>
					</div>
				</div>
			</div>
		</div>

</div>


<div id="game" class="container" style="display:none">
    <div id="myProgress">
        <div id="myBar"></div>
    </div>
    <div class="row justify-content-md-center">
        <div class="col-10 alert alert-success" role="alert"><h2 id="question">Frage</h2></div>
        <div class="col-10 py-3 px-lg-5 border bg-light">
            <div class=" row mx-lg-n5">
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="0"><h2 id="a1">A1</h2></div>
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="1"><h2 id="a2">A2</h2></div>
            </div>

            <div class="row mx-lg-n5">
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="2"><h2 id="a3">A3</h2></div>
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="3"><h2 id="a4">A4</h2></div>
            </div>
        </div>
    </div>
</div>

<div id="scoreboard" class="container" style="display:none">
    <div class="col-8 alert alert-success" role="alert" id="scores"><h2>Scoreboard</h2>
        <div id="scores-id"></div>
    </div>
    <form onsubmit=" return backToMenu()">
      <button style="width: 25%">Back to Menu</button>
    </form>
</div>
</main>
<!-- game functions -->
<script>
    var pID = -1
    var gameID = -1

    function onclickanswer(answerID, questionID){
        var payload = {
            "type": "answered_question",
            "p_id": pID,
            "game_id": gameID,
            "q_id": -1,
            "a_id" : answerID
        };
        //TODO trigger button disable
        // Make the request to the WebSocket.
        sendSocket(payload);
    }
    function startLobby(){
      document.getElementById("menu").style.display = "none"
      document.getElementById("room").style.display = "inline"

      var payload = {
        "type": "join_lobby",
        "p_id": pID
      }
      sendSocket(payload);
      return false;
    }
    function startGame() {
        //check player...
        //hide chat
        document.getElementById("room").style.display = "none"
        document.getElementById("game").style.display = "inline"
        return false;
    }
    function startScoreboard(){
        document.getElementById("game").style.display = "none"
        document.getElementById("scoreboard").style.display = "inline"
    }
    function backToMenu(){
        document.getElementById("scoreboard").style.display = "none"
        document.getElementById("menu").style.display = "inline"
        return false;
    }

    function move() {
        var elem = document.getElementById("myBar");
        var width = 1;
        var id = setInterval(frame, 120);
        var payload = {
            "type": "question"
        }
        function frame() {
            if (width == 100) {
                // Make the request to the WebSocket.
                sendSocket(payload);
                elem.style.width = '0%';
                clearInterval(id);
                move()
            } else {
                width++;
                elem.style.width = width + '%';
            }
        }
        //next question
    }
    var username = prompt("What's your name?");
    var ws = new WebSocket("ws://localhost:8888/websocket/username/" + username);
    ws.onmessage = function (evt) {
        console.log(evt.data)
        var messageDict = JSON.parse(evt.data);
        // Create a div with the format `user: message`.
        if ('type' in messageDict) {
            switch (messageDict.type) {
                case "login": {
                  if(messageDict.p_id != -1){
                    alert("successfully logged in");
                    pID = messageDict.p_id
                  }
                  else{
                    alert("user not known");
                  }
                }
                break;
                //do some message
                case "user_message": {
                    var messageBox = document.createElement("div");
                    messageBox.className = 'd-flex justify-content-start mb-4';
                    var userbox = document.createElement('div');
                    userbox.className = 'img_cont_msg';
                    var userimg = document.createElement('img');
                    userimg.className =  'rounded-circle user_img_msg'
                    userimg.src = '/img/iconfinder_icon-64-face-sunglasses_315578.png';
                    userbox.appendChild(userimg);
                    var usermsg = document.createElement('div');
                    usermsg.className = "msg_cotainer";
                    usermsg.innerHTML = messageDict.message
                    var usertime = document.createElement('span');
                    usertime.className = "msg_time";
                    usertime.innerHTML = "8:40 AM, Today";
                    usermsg.appendChild(usertime);
                    messageBox.appendChild(userbox);
                    messageBox.appendChild(usermsg);
                    document.getElementById("messages").appendChild(messageBox)
                }
                break;
                //close connect
                case "close": {
                    var n_div = document.getElementById("users-id").getElementsByTagName('div');
                    //var users = messageDict.user.split(',');
                    for (var i = 0, n = n_div.length; i < n; i = i + 1) {
                        var s_id = n_div[i].id;
                        if (!messageDict.user.includes(s_id)) {
                            document.getElementById(s_id).remove();
                        }
                    }
                }
                //open connection
                case "lobby": {
                    //remove all old users from the box to avoid duplicates
                    var users = document.getElementById("contacts");
                    if(users.hasChildNodes()){
                        var children = users.childNodes;
                        for(var i = 0; i < children.length; i++){
                            users.removeChild(children[i]);
                        }
                    }

                    //put the users
                    for (id in messageDict.lobby) {
                        var userBox = document.createElement("li");
                        userBox.className = 'active';
                        //userBox.innerHTML = messageDict.lobby[id];
                        var userdiv = document.createElement('div');
                            userdiv.className = 'd-flex bd-highlight';
                        var imgdiv = document.createElement('div');
                            imgdiv.className = 'img_cont';
                        var uimg = document.createElement('img');
                            uimg.className = 'rounded-circle user_img';
                            uimg.src = '/img/iconfinder_icon-64-face-sunglasses_315578.png';
                        var uimgspan = document.createElement('span');
                            uimgspan.className = 'online_icon';
                        imgdiv.appendChild(uimg)
                        imgdiv.appendChild(uimgspan)
                        var udivdesc = document.createElement('div');
                            udivdesc.className = 'user_info';
                        var udivtext = document.createElement('span');
                            udivtext.innerHTML = messageDict.nicks[id];
                        udivdesc.appendChild(udivtext)
                        userdiv.appendChild(imgdiv)
                        userdiv.appendChild(udivdesc)
                        userBox.appendChild(userdiv)
                        userBox.setAttribute('id', messageDict.lobby[id]);
                        document.getElementById("contacts").appendChild(userBox);
                    }
                }
                break;
                case "game_start":{
                    gameID = messageDict.game_id;
                    startGame();
                }
                break;
                //do a question
                case 'question': {
                    document.getElementById('question').innerHTML = messageDict.question.questioning;
                    var answers = messageDict.question.answers;
                    for (answerid in answers ){
                        document.getElementById("a"+(parseFloat(answerid)+1)).innerHTML = answers[answerid].content;
                    }
                    var b_answers = document.getElementsByClassName('answer');
                    for (var i=0; i < b_answers.length; i++){
                        console.log(i + 1 + " " + messageDict.question.id)
                        b_answers[i].onclick = function(e){ onclickanswer(i + 1, messageDict.question.id) }; //put this as param back in
                        b_answers[i].className = "col py-3 px-lg-5 btn btn-outline-info answer";
                    }
                    //TODO start timer bar
                }
                break;
                case "scoreboard": {

                    //remove any old scores from previous games
                    var oldScores = document.getElementById("scores-id");
                    if(oldScores.hasChildNodes()){
                        var children = oldScores.childNodes;
                        for(var i = 0; i < children.length; i++){
                            oldScores.removeChild(children[i]);
                        }
                    }

                    //create new div containing playerID : score for each participant
                    //TODO fix display of score of previous games
                    for(playerID in messageDict.scoreboard){
                        var scoreBox = document.createElement("div");
                        if(playerID == pID){ //my own score
                            scoreBox.innerHTML = "you: " + messageDict.scoreboard[playerID];
                        }
                        else{
                            scoreBox.innerHTML = playerID + ": " + messageDict.scoreboard[playerID];
                        }
                        document.getElementById("scores-id").appendChild(scoreBox);
                    }
                    startScoreboard();

                }
                break;
                //answered question
                case 'answer_quest': {
                    var b_answers = document.getElementsByClassName('answer');
                    for (var i=0; i<b_answers.length; i++){
                        b_answers[i].onclick = false;
                        b_answers[i].className = "col py-3 px-lg-5 btn btn btn-secondary answer";
                    }
                    document.getElementById(messageDict.id).className = "col py-3 px-lg-5 btn btn btn-primary answer";
                }
                break;
            }
        } else {
            //alert('something getting wrong')
        }
        ;
    };
    ws.onopen = function (e) {
        var welcome = {
            "type": 'login',
            "user": username
        }
        sendSocket(welcome);
    }
    function sendMessage() {
        var messageInput = document.getElementById("message");
        var message = messageInput.value;
        var payload = {
            "type": "user_message",
            "message": message,
            "p_id": pID
        }
        // Make the request to the WebSocket.
        sendSocket(payload);
        // Clear the message from the input.
        messageInput.value = "";
        return false;
    }

    function sendSocket(payload){
        jsonMessage = JSON.stringify(payload)
        ws.send(jsonMessage);
        console.log("sent: " + jsonMessage);
    }
</script>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
        crossorigin="anonymous"></script>
</body>
</html>
