<!DOCTYPE html>
<html>
<head>
    <title>Application</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        #myProgress {
            width: 100%;
            background-color: grey;
        }
        #myBar {
            width: 0%;
            height: 30px;
            background-color: green;
        }
    </style>
</head>
<body>
<div id="menu" class="container px-lg-5" style="width:100%, padding: 20px; overflow-y: scroll; display:inline">
  <div style="padding-top: 20px;">
    <form onsubmit=" return startLobby()">
      <button style="width: 25%">Play</button>
    </form>
  </div>
</div>
<div id="room" class="container px-lg-5" style="width:100%; padding: 20px; overflow-y: scroll; display:none">
    <div class="row">
        <div class="col-8 alert alert-success" role="alert" id="messages"><h2>Chat</h2></div>
        <div class="col-4 alert alert-info" role="alert" id="users"><h2>Users</h2>
            <div id="users-id"></div>
        </div>
    </div>
    <div style="padding-top: 20px;">
        <form onsubmit="return sendMessage()">
            <input id="message" type="text" style="width: 70%;">
            <button style="width: 25%">Send</button>
        </form>
    </div>
</div>


<div id="game" class="container" style="display:none">
    <div id="myProgress">
        <div id="myBar"></div>
    </div>
    <div class="row justify-content-md-center">
        <div class="col-10 alert alert-success" role="alert"><h2 id="question">Frage</h2></div>
        <div class="col-10 py-3 px-lg-5 border bg-light">
            <div class=" row mx-lg-n5">
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="0"><h2 id="a1">A1</h2></div>
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="1"><h2 id="a2">A2</h2></div>
            </div>

            <div class="row mx-lg-n5">
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="2"><h2 id="a3">A3</h2></div>
                <div type="button" class="col py-3 px-lg-5 btn btn-outline-info answer" id="3"><h2 id="a4">A4</h2></div>
            </div>
        </div>
    </div>
</div>

<div id="scoreboard" class="container" style="display:none">
    <div class="col-8 alert alert-success" role="alert" id="scores"><h2>Scoreboard</h2>
        <div id="scores-id"></div>
    </div>
    <form onsubmit=" return backToMenu()">
      <button style="width: 25%">Back to Menu</button>
    </form>
</div>

<!-- game functions -->
<script>
    var pID = -1
    var gameID = -1
    var progressBar = null;

    function onclickanswer(btn, questionID){
        var payload = {
            "type": "answered_question",
            "p_id": pID,
            "game_id": gameID,
            "q_id": questionID,
            "a_id" : parseInt(btn.id) + 1
        };
        //stop the timer
        clearInterval(progressBar);
        //evaluate the given answer
        evalQuestion(btn);
        //send answer to the server
        sendSocket(payload);
    }

    function evalQuestion(pressedBtn){
        //first disable all button onclicks
        var b_answers = document.getElementsByClassName('answer');
        for (var i=0; i<b_answers.length; i++){
            b_answers[i].onclick = false;
        }
        //correct answer was chosen, make this button green
        if(parseInt(pressedBtn.id) == 0){
            pressedBtn.className = "col py-3 px-lg-5 btn btn btn-success answer";
        }
        //wrong answer chosen, make pressed button red and button with correct answer green
        else{
            pressedBtn.className = "col py-3 px-lg-5 btn btn btn-danger answer";
            //we cant directly access the buttons div with id=0 because also in lobby there are divs with id's
            //--> wrong element could be taken, to avoid that loop only over answers
            for(var i = 0; i < b_answers.length; i++){
                if(b_answers[i].id == 0){
                    b_answers[i].className = "col py-3 px-lg-5 btn btn btn-success answer";
                }
            }
        }
    }

    function startLobby(){
        //hide menu and show lobby
      document.getElementById("menu").style.display = "none"
      document.getElementById("room").style.display = "inline"

      var payload = {
        "type": "join_lobby",
        "p_id": pID
      }
      sendSocket(payload);
      return false;
    }
    function startGame() {
        //hide lobby, delete chat and show game
        document.getElementById("room").style.display = "none"
        clearChildren("messages");
        document.getElementById("game").style.display = "inline"
        return false;
    }
    function startScoreboard(){
        //hide game and show scoreboard
        document.getElementById("game").style.display = "none"
        document.getElementById("scoreboard").style.display = "inline"
    }
    function backToMenu(){
        //hide scoreboard and show menu
        document.getElementById("scoreboard").style.display = "none"
        document.getElementById("menu").style.display = "inline"
        return false;
    }

    function move() {
        var elem = document.getElementById("myBar");
        var width = 1;
        progressBar = setInterval(frame, 120);

        function frame() {
            if (width == 100) {
                elem.style.width = '0%';
                clearInterval(progressBar);
            } else {
                width++;
                elem.style.width = width + '%';
            }
        }
    }

    var username = prompt("What's your name?");
    var ws = new WebSocket("ws://localhost:8888/websocket/username/" + username);
    ws.onmessage = function (evt) {
        console.log(evt.data)
        //parse the json response
        var messageDict = JSON.parse(evt.data);
        if ('type' in messageDict) { //type always needs to be in the response
            switch (messageDict.type) {
                //check if ur username is known by the server
                //TODO auth with password
                case "login": {
                  if(messageDict.p_id != -1){
                    alert("successfully logged in");
                    pID = messageDict.p_id
                  }
                  else{
                    alert("user not known");
                  }
                }
                break;
                //display chat messages
                case "user_message": {
                    var messageBox = document.createElement("div");
                    messageBox.innerHTML = messageDict.p_id + ": " + messageDict.message;
                    document.getElementById("messages").appendChild(messageBox)
                }
                break;
                //close connect
                case "close": {
                    //do nothing for now
                }
                //a player joined the lobby
                case "lobby": {
                    //remove all old users from the box to avoid duplicates
                    clearChildren("users-id");
                    //put the users
                    for (id in messageDict.lobby) {
                        var userBox = document.createElement("div");
                        userBox.innerHTML = messageDict.lobby[id];
                        userBox.setAttribute('id', messageDict.lobby[id]);
                        document.getElementById("users-id").appendChild(userBox);
                    }
                }
                break;
                //enough players in the lobby --> games starts
                case "game_start":{
                    gameID = messageDict.game_id;
                    startGame();
                }
                break;
                //play a question
                case 'question': {
                    document.getElementById('question').innerHTML = messageDict.question.questioning;
                    var answers = messageDict.question.answers;
                    for (answerid in answers ){
                        document.getElementById("a"+(parseFloat(answerid)+1)).innerHTML = answers[answerid].content;
                    }
                    //TODO shuffle order of questions since id=1 is the correct answer
                    var b_answers = document.getElementsByClassName('answer');
                    for (var i=0; i < b_answers.length; i++){
                        b_answers[i].onclick = function(e){ onclickanswer(this, messageDict.question.id) };
                        b_answers[i].className = "col py-3 px-lg-5 btn btn-outline-info answer";
                    }

                    //reset + restart the timer bar
                    document.getElementById("myBar").style.width = '0%';
                    move();

                }
                break;
                //all questions played --> show scoreboard
                case "scoreboard": {

                    //remove any old scores from previous games
                    clearChildren("scores-id");

                    //create new div containing playerID : score for each participant
                    for(playerID in messageDict.scoreboard){
                        var scoreBox = document.createElement("div");
                        if(playerID == pID){ //my own score
                            scoreBox.innerHTML = "you: " + messageDict.scoreboard[playerID];
                        }
                        else{
                            scoreBox.innerHTML = playerID + ": " + messageDict.scoreboard[playerID];
                        }
                        document.getElementById("scores-id").appendChild(scoreBox);
                    }
                    startScoreboard();

                }
                break;
            }
        } else {
            alert('"type" key missing in message')
        }
        ;
    };
    ws.onopen = function (e) {
        var welcome = {
            "type": 'login',
            "user": username
        }
        sendSocket(welcome);
    }
    //send a chat message to the server, will be broadcasted to players
    function sendMessage() {
        var messageInput = document.getElementById("message");
        var message = messageInput.value;
        var payload = {
            "type": "user_message",
            "message": message,
            "p_id": pID
        }
        // Make the request to the WebSocket.
        sendSocket(payload);
        // Clear the message from the input.
        messageInput.value = "";
        return false;
    }
    //helper function to clear child nodes
    function clearChildren(parentID){
        var parent = document.getElementById(parentID);
        if(parent){
            while(parent.firstChild){
                parent.removeChild(parent.firstChild);
            }
        }
    }
    //wrapper to send a message to the server via socket
    function sendSocket(payload){
        jsonMessage = JSON.stringify(payload)
        ws.send(jsonMessage);
        console.log("sent: " + jsonMessage);
    }
</script>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
        crossorigin="anonymous"></script>
</body>
</html>
